version: '3.8'

services:
  # 1. The Brain (Go Backend)
  backend:
    build: ./backend
    container_name: saferide-backend
    ports:
      - "8080:8080" # HTTP API for Frontend
    environment:
      - REDIS_ADDR=redis:6379
      - MQTT_BROKER=tcp://mosquitto:1883
      - SOLANA_RPC=https://api.devnet.solana.com
      # Add your private key here via .env file for security
      - SOLANA_PRIVATE_KEY=${SOLANA_PRIVATE_KEY}
    depends_on:
      - redis
      - mosquitto
    networks:
      - saferide-net

  # 2. The Memory (Redis Cache)
  redis:
    image: redis:alpine
    container_name: saferide-redis
    ports:
      - "6379:6379" # Exposed for local debugging if needed
    networks:
      - saferide-net

  # 3. The Nervous System (MQTT Broker)
  mosquitto:
    image: eclipse-mosquitto
    container_name: saferide-mqtt
    ports:
      - "1883:1883" # MQTT Port (Pico connects here)
      - "9001:9001" # Websocket Port (Optional)
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - saferide-net

  # 4. The Face (SvelteKit)
  frontend:
    build: ./frontend
    container_name: saferide-frontend
    ports:
      - "3000:3000"
    environment:
      # In docker-compose, frontend calls backend via browser, so localhost is correct for client-side calls?
      # NO. SvelteKit Server-Side Load calls might need internal DNS (backend:8080).
      # But Client-Side calls need localhost:8080 (from user's browser).
      # Usually SvelteKit needs both or special handling. 
      # For this simple demo, let's assume client-side fetching mainly.
      - PUBLIC_API_URL=http://localhost:8080
    depends_on:
      - backend

networks:
  saferide-net:
    driver: bridge